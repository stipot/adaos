# Безопасность и доверие

Архитектура AdaOS изначально проектируется с упором на безопасность:  
минимальные права по умолчанию, явные политики и централизованная система доверия.

---

## Политики (Policies)

### Capabilities

- Управление правами на действия (например, доступ к сетевым запросам или файловой системе).  
- Выдаются сервисам и навыкам в момент инициализации.  
- Пример: `caps: ["skills.install", "scenarios.run"]`.

### NetPolicy

- Белый список доменов и сетей.  
- Навыки могут обращаться только к разрешённым адресам.  
- Пример: `allow = ["*.github.com", "api.openai.com"]`.

### FSPolicy

- Определяет разрешённые корни файловой системы.  
- Навыки не могут читать/писать за пределами этих директорий.  
- Пример: `skills_dir`, `scenarios_dir`, `cache`.

---

## Secrets

### Основные принципы

- Секреты никогда не пишутся в события или логи.  
- CLI выводит секреты только по явному `--show`.

### Реализация

- **OS keyring** — основной бэкенд.  
- **FileVault** — фолбэк, если keyring недоступен (например, в CI или на минимальной ОС).  
  - Шифрование через Fernet.  
  - Мастер-ключ хранится в keyring или передаётся через ENV.  

---

## Модель доверия

### Root ↔ Hub ↔ Agent

- **Root** — центральный сервер управления сертификатами.  
- **Hub** — регистрируется в Root, получает доверенный сертификат.  
- **Agent** — присоединяется к Hub, наследует его доверие.  

### Принципы

- Регистрация хостов только через Root.  
- Двухфакторная аутентификация (например, email + телефон, или QR-код при инициализации).  
- Изолированные подсети без Root-доверия **не поддерживаются**.  

### Поток

1. Hub инициирует регистрацию в Root.  
2. Root выдаёт сертификат (X.509) для Hub.  
3. Hub развёртывает сертификат на своих агентах.  
4. Вся коммуникация (CLI/API/LLM) идёт по защищённому каналу.  

---

## Пример использования SecretsService

```python
from adaos.services.secrets import SecretsService

secrets = SecretsService()
secrets.write("openai/api_key", "sk-...")
print(secrets.read("openai/api_key"))
````

---

## Будущие шаги

- Гранулированные политики доступа к секретам: `subject="skill:<id>"`.
- Поддержка аппаратных хранилищ (TPM, HSM).
- Централизованное управление отозванными сертификатами (CRL).
